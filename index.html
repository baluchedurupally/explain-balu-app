<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Explain Docs ‚Äî balu.app</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto px-4 py-10">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">Explain Docs</h1>
      <p class="mt-2 text-slate-600">
        Upload a document photo/PDF or paste text ‚Üí Pay ‚Çπ5 ‚Üí Get a simple explanation.
      </p>
      <p class="mt-2 text-xs text-slate-500">
        Disclaimer: This service explains documents in simple language. It does not provide legal, medical, or financial advice.
      </p>
    </header>

    <!-- STEP 1: INPUT -->
    <section id="stepInput" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-xl font-semibold">1) Add your document</h2>
        <div class="text-sm text-slate-600">
          Price: <span class="font-semibold">‚Çπ5</span> / document
        </div>
      </div>

      <div class="mt-6 grid gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">Upload image / PDF</label>
          <input id="fileInput" type="file" accept="image/*,application/pdf"
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4
                        file:rounded-xl file:border-0 file:text-sm file:font-semibold
                        file:bg-slate-900 file:text-white hover:file:bg-slate-800
                        border border-slate-200 rounded-xl p-2 bg-white" />
          <p class="mt-2 text-xs text-slate-500">Tip: Clear photo works best (no glare, full page visible).</p>
        </div>

        <div class="flex items-center gap-3">
          <div class="h-px bg-slate-200 flex-1"></div>
          <div class="text-xs text-slate-500">OR</div>
          <div class="h-px bg-slate-200 flex-1"></div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Paste text</label>
          <textarea id="textInput" rows="6"
            placeholder="Paste the document text here‚Ä¶"
            class="w-full border border-slate-200 rounded-xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-slate-900"></textarea>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Output language</label>
            <select id="language" class="w-full border border-slate-200 rounded-xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-slate-900">
              <option value="en" selected>English</option>
              <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
              <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Document category (optional)</label>
            <select id="category" class="w-full border border-slate-200 rounded-xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-slate-900">
              <option value="">Auto-detect</option>
              <option value="bank">Bank</option>
              <option value="school">School</option>
              <option value="medical">Medical</option>
              <option value="insurance">Insurance</option>
              <option value="hr">HR / Salary</option>
              <option value="govt">Government</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between mt-2">
          <div class="text-sm text-slate-600">
            <span id="inputStatus">No document selected yet.</span>
          </div>
          <button id="payBtn"
            class="inline-flex items-center justify-center rounded-xl bg-slate-900 text-white px-5 py-3 font-semibold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
            Pay ‚Çπ5 & Explain
          </button>
        </div>
      </div>
    </section>

    <!-- STEP 2: STATUS -->
    <section id="stepStatus" class="hidden mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-xl font-semibold">2) Processing</h2>
      <div class="mt-3 flex items-center gap-3">
        <div class="h-3 w-3 rounded-full bg-slate-900 animate-pulse"></div>
        <p id="statusText" class="text-slate-700">Starting‚Ä¶</p>
      </div>
      <div class="mt-4">
        <button id="backBtn" class="text-sm font-semibold text-slate-900 underline">
          Go back
        </button>
      </div>
    </section>

    <!-- STEP 3: RESULT -->
    <section id="stepResult" class="hidden mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 class="text-xl font-semibold">3) Explanation</h2>
        <button id="newBtn"
          class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 font-semibold hover:bg-slate-50">
          Explain another
        </button>
      </div>

      <div class="mt-6 grid gap-4">
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold">üìÑ What this document is</div>
          <div id="outWhat" class="mt-2 text-slate-700 whitespace-pre-wrap"></div>
        </div>

        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold">‚ö†Ô∏è How serious it is</div>
          <div class="mt-2 flex items-center gap-2">
            <span id="outSeriousBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold bg-slate-100 text-slate-900">
              ‚Äî
            </span>
            <span id="outSeriousText" class="text-slate-700 whitespace-pre-wrap"></span>
          </div>
        </div>

        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold">‚û°Ô∏è What you should do next</div>
          <div id="outNext" class="mt-2 text-slate-700 whitespace-pre-wrap"></div>
        </div>

        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold">üòå What you do NOT need to worry about</div>
          <div id="outNoWorry" class="mt-2 text-slate-700 whitespace-pre-wrap"></div>
        </div>

        <div class="text-xs text-slate-500">
          Note: This is a simplified explanation based only on the provided document text/image. If anything is unclear, consult the issuing organization or a qualified professional.
        </div>
      </div>
    </section>

    <!-- ERROR TOAST -->
    <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-3 rounded-xl shadow-lg text-sm">
      Something went wrong.
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG: set your backend base URL
    // ==============================
    const API_BASE = "https://explain-api.balu-net.workers.dev"; // e.g. https://api.balu.app or https://<azure-func>.azurewebsites.net

    // Expected backend endpoints:
    // POST  /create-order        -> { orderId, amount, currency, keyId }
    // POST  /process-doc         -> returns { what, seriousness: { level, text }, next, noWorry }
    //
    // For now, this UI is "locked". You can return mocked responses from backend while building.

    const fileInput = document.getElementById("fileInput");
    const textInput = document.getElementById("textInput");
    const language = document.getElementById("language");
    const category = document.getElementById("category");
    const payBtn = document.getElementById("payBtn");
    const inputStatus = document.getElementById("inputStatus");

    const stepInput = document.getElementById("stepInput");
    const stepStatus = document.getElementById("stepStatus");
    const stepResult = document.getElementById("stepResult");
    const statusText = document.getElementById("statusText");

    const outWhat = document.getElementById("outWhat");
    const outSeriousBadge = document.getElementById("outSeriousBadge");
    const outSeriousText = document.getElementById("outSeriousText");
    const outNext = document.getElementById("outNext");
    const outNoWorry = document.getElementById("outNoWorry");

    const backBtn = document.getElementById("backBtn");
    const newBtn = document.getElementById("newBtn");
    const toast = document.getElementById("toast");

    const SKIP_PAYMENT_FOR_NOW = true;

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3500);
    }

    function hasInput() {
      const hasFile = fileInput.files && fileInput.files.length > 0;
      const hasText = (textInput.value || "").trim().length > 0;
      return hasFile || hasText;
    }

    function refreshStatus() {
      const hasFile = fileInput.files && fileInput.files.length > 0;
      const hasText = (textInput.value || "").trim().length > 0;

      if (hasFile) {
        inputStatus.textContent = `Selected file: ${fileInput.files[0].name}`;
      } else if (hasText) {
        inputStatus.textContent = `Text ready (${textInput.value.trim().length} chars)`;
      } else {
        inputStatus.textContent = "No document selected yet.";
      }
      payBtn.disabled = !hasInput();
    }

    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) textInput.value = ""; // enforce one source
      refreshStatus();
    });

    textInput.addEventListener("input", () => {
      if ((textInput.value || "").trim().length > 0) fileInput.value = "";
      refreshStatus();
    });

    refreshStatus();

    function setStep(which) {
      stepInput.classList.toggle("hidden", which !== "input");
      stepStatus.classList.toggle("hidden", which !== "status");
      stepResult.classList.toggle("hidden", which !== "result");
    }

    backBtn.addEventListener("click", () => setStep("input"));
    newBtn.addEventListener("click", () => {
      fileInput.value = "";
      textInput.value = "";
      refreshStatus();
      setStep("input");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Minimal Razorpay loader (optional). If you prefer payment-link/QR first, skip this entirely.
    async function loadRazorpayScript() {

        
      return new Promise((resolve, reject) => {
        if (window.Razorpay) return resolve(true);
        const s = document.createElement("script");
        s.src = "https://checkout.razorpay.com/v1/checkout.js";
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error("Failed to load Razorpay"));
        document.body.appendChild(s);
      });
    }

    async function createOrder() {
      // Your backend should create a Razorpay order and return keyId + orderId.
      const res = await fetch(`${API_BASE}/create-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: 500, currency: "INR", purpose: "doc_explain" }) // amount in paise
      });
      if (!res.ok) throw new Error("Order creation failed");
      return res.json();
    }

    async function processDoc(paymentToken) {
        console.log("API_BASE:", API_BASE);

        const langCode = document.getElementById("language").value; // en/te/hi/ta
        const cat = document.getElementById("category")?.value || "auto";
        const pastedText = document.getElementById("textInput")?.value?.trim() || "";

        console.log("Selected language:", langCode);

        // ---------- FILE UPLOAD (multipart) ----------
        if (fileInput.files && fileInput.files.length > 0) {
            const fd = new FormData();
            fd.append("paymentToken", paymentToken);
            fd.append("outputLanguage", langCode);   // ‚úÖ keep same field name as JSON path
            fd.append("category", cat);
            fd.append("file", fileInput.files[0]);

            const res = await fetch(`${API_BASE}/process-doc`, {
            method: "POST",
            body: fd, // ‚úÖ IMPORTANT: send FormData
            });

            const raw = await res.text();
            console.log("process-doc status:", res.status);
            console.log("process-doc response:", raw);

            if (!res.ok) throw new Error(raw || `HTTP ${res.status}`);
            return JSON.parse(raw);
        }

        // ---------- TEXT (JSON) ----------
        if (!pastedText) {
            throw new Error("Please paste document text for now. (OCR for images is coming next.)");
        }

        const res = await fetch(`${API_BASE}/process-doc`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
            paymentToken,
            text: pastedText,
            outputLanguage: langCode,  // ‚úÖ from UI
            category: cat
            })
        });

        const raw = await res.text();
        console.log("process-doc status:", res.status);
        console.log("process-doc response:", raw);

        if (!res.ok) throw new Error(raw || `HTTP ${res.status}`);
        return JSON.parse(raw);
    }

    function renderResult(data) {
      outWhat.textContent = data.what || "‚Äî";

      const level = (data.seriousness && data.seriousness.level) ? data.seriousness.level : "Unknown";
      const levelUpper = String(level).toUpperCase();
      outSeriousBadge.textContent = levelUpper;

      // Keep badge styling minimal (no custom colors needed)
      outSeriousText.textContent = (data.seriousness && data.seriousness.text) ? data.seriousness.text : "";

      outNext.textContent = data.next || "‚Äî";
      outNoWorry.textContent = data.noWorry || "‚Äî";
    }

    // Main click
    payBtn.addEventListener("click", async () => {
      try {
        if (!hasInput()) return;

        setStep("status");
        statusText.textContent = "Preparing payment‚Ä¶";

        // If you're not ready for Razorpay order flow yet:
        // You can temporarily skip payment and use a hardcoded token from backend.
        // But keep UI same.
        /*
        await loadRazorpayScript();

        const order = await createOrder();

        // Open Razorpay Checkout
        statusText.textContent = "Waiting for payment‚Ä¶";
        
        const rzp = new window.Razorpay({
          key: order.keyId,
          amount: order.amount,
          currency: order.currency,
          name: "Explain Docs (balu.app)",
          description: "Document explanation (‚Çπ5)",
          order_id: order.orderId,
          handler: async function (response) {
            // response contains razorpay_payment_id, razorpay_order_id, razorpay_signature
            // Your backend should verify signature and mint paymentToken.
            try {

              if (SKIP_PAYMENT_FOR_NOW) {
                setStep("status");
                statusText.textContent = "Processing document‚Ä¶";
                const result = await processDoc("token_stub_paid");
                renderResult(result);
                setStep("result");
                return;
                }

              statusText.textContent = "Verifying payment‚Ä¶";
              const verifyRes = await fetch(`${API_BASE}/verify-payment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(response)
              });
              if (!verifyRes.ok) throw new Error("Payment verification failed");
              const verified = await verifyRes.json(); // { paymentToken: "..." }

              statusText.textContent = "Processing document‚Ä¶";
              const result = await processDoc(verified.paymentToken);

              renderResult(result);
              setStep("result");
              window.scrollTo({ top: 0, behavior: "smooth" });
            } catch (e) {
              console.error(e);
              setStep("input");
              showToast(e.message || "Payment/processing failed");
            }
          },
          modal: {
            ondismiss: function () {
              setStep("input");
              showToast("Payment cancelled.");
            }
          },
          theme: { color: "#0f172a" }
        }); 

        rzp.open();
        */

        // For now, skip payment and use a hardcoded token from backend.
        if (SKIP_PAYMENT_FOR_NOW) {
          setStep("status");
          statusText.textContent = "Processing document‚Ä¶";
          const result = await processDoc("token_stub_paid");
          renderResult(result);
          setStep("result");
          window.scrollTo({ top: 0, behavior: "smooth" });
          return;
        }

      } catch (e) {
        console.error(e);
        setStep("input");
        showToast(e.message || "Something went wrong");
      }
    });
  </script>
</body>
</html>
